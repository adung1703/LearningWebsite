var f=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var X=f((Dt,is)=>{var W=require("./node_modules/mongoose/index.js"),se=new W.Schema({fullname:{type:String,required:!0},username:{type:String,required:!0,unique:!0},email:{type:String,unique:!0},phoneNumber:{type:String,unique:!0},password:{type:String,required:!0},role:{type:String,default:"user"},avatar:{type:String,default:"https://learningwebsite-1.s3.ap-southeast-1.amazonaws.com/user-avatar/default-user-avatar.png"},coursesJoined:{type:[W.Schema.Types.ObjectId],ref:"Courses"},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});is.exports=W.model("Users",se)});var k=f((Tt,ls)=>{var $=require("./node_modules/mongoose/index.js"),ee=new $.Schema({userId:{type:$.Schema.Types.ObjectId,ref:"Users"},courseId:{type:$.Schema.Types.ObjectId,ref:"Courses"},progress:{type:[{chapter_order:Number,lessons_completed:[$.Schema.Types.ObjectId],assignments_completed:[$.Schema.Types.ObjectId],status:{type:String,enum:["completed","in-progress","not-started"],default:"not-started"}}],default:[]},last_update:{type:Date,default:Date.now}});ls.exports=$.model("CourseProgresses",ee)});var v=f((Ot,ds)=>{var L=require("./node_modules/mongoose/index.js"),te=new L.Schema({title:{type:String,required:!0},description:{type:String},price:{type:Number},image:{type:String},instructor:{type:L.Schema.Types.ObjectId,ref:"Users"},category:{type:[String]},chapters:{type:[{chapter_title:String,order:Number,content:[{content_type:String,lesson_id:L.Schema.Types.ObjectId,assignment_id:{type:L.Schema.Types.ObjectId,ref:"Assignments"},order:Number}]}]},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});ds.exports=L.model("Courses",te)});var K=f((At,ms)=>{var{S3Client:ne}=require("./node_modules/@aws-sdk/client-s3/dist-cjs/index.js");require("./node_modules/dotenv/lib/main.js").config();var ae=new ne({region:"ap-southeast-1",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY}}),oe="ap-southeast-1";ms.exports={s3Client:ae,region:oe}});var hs=f(D=>{var U=X(),re=k(),ce=v(),Y=require("./node_modules/bcrypt/bcrypt.js"),ue=require("./node_modules/jsonwebtoken/index.js"),{PutObjectCommand:ie,DeleteObjectCommand:le}=require("./node_modules/@aws-sdk/client-s3/dist-cjs/index.js"),{s3Client:ps,region:de}=K(),me=require("./node_modules/multer/index.js"),gs=require("fs"),pe=require("path"),ge=me({dest:"uploads/"});D.registerUser=async(t,e)=>{try{let{fullname:s,username:a,email:n,phoneNumber:c,password:o,role:r,avatar:u,create_at:l}=t.body,i=await Y.hash(o,10);await new U({fullname:s,username:a,email:n,phoneNumber:c,password:i,role:r,avatar:u,create_at:l}).save(),e.status(201).json({success:!0,message:"\u0110\u0103ng k\xFD t\xE0i kho\u1EA3n th\xE0nh c\xF4ng!"})}catch(s){e.status(500).json({success:!1,message:s.message})}};D.loginUser=async(t,e)=>{try{let{identifier:s,password:a}=t.body,n=await U.findOne({$or:[{username:s},{email:s},{phoneNumber:s}]});if(!n)return e.status(400).json({success:!1,message:"T\xE0i kho\u1EA3n kh\xF4ng t\u1ED3n t\u1EA1i"});if(!await Y.compare(a,n.password))return e.status(400).json({success:!1,message:"M\u1EADt kh\u1EA9u kh\xF4ng ch\xEDnh x\xE1c"});let o=ue.sign({id:n._id,username:n.username,fullname:n.fullname,email:n.email,phoneNumber:n.phoneNumber,password:n.password,role:n.role,coursesJoined:n.coursesJoined,avatar:n.avatar,create_at:n.create_at},process.env.JWT_SECRET,{expiresIn:process.env.JWT_EXPIRES_IN});e.status(200).json({success:!0,token:o})}catch(s){console.error("L\u1ED7i khi \u0111\u0103ng nh\u1EADp:",s),e.status(500).json({success:!1,message:"\u0110\xE3 x\u1EA3y ra l\u1ED7i khi \u0111\u0103ng nh\u1EADp"})}};D.getUserInfo=async(t,e)=>{try{let s=await U.findById(t.user.id).select("-password");if(!s)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ng\u01B0\u1EDDi d\xF9ng"});e.status(200).json({success:!0,user:s})}catch(s){console.error("L\u1ED7i khi l\u1EA5y th\xF4ng tin ng\u01B0\u1EDDi d\xF9ng:",s),e.status(500).json({success:!1,message:"\u0110\xE3 x\u1EA3y ra l\u1ED7i khi l\u1EA5y th\xF4ng tin ng\u01B0\u1EDDi d\xF9ng"})}};D.joinCourse=async(t,e)=>{try{if(!t.body||t.body===void 0||t.body===""||t.body===null)return e.status(400).json({success:!1,message:"Thi\u1EBFu th\xF4ng tin kh\xF3a h\u1ECDc"});let{courseId:s}=t.body;if(!s||s===void 0||s===""||s===null)return e.status(400).json({success:!1,message:"Thi\u1EBFu th\xF4ng tin kh\xF3a h\u1ECDc"});let a=await U.findById(t.user.id);if(!a)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ng\u01B0\u1EDDi d\xF9ng"});if(a.coursesJoined.includes(s))return e.status(400).json({success:!1,message:"B\u1EA1n \u0111\xE3 tham gia kh\xF3a h\u1ECDc n\xE0y r\u1ED3i"});a.coursesJoined.push(s),await a.save();let n=await ce.findById(s),c=new re({userId:t.user.id,courseId:s});n.chapters.forEach(o=>{c.progress.push({chapter_order:o.order,lessons_completed:[],assignments_completed:[]})}),await c.save(),e.status(200).json({success:!0,message:"Tham gia kh\xF3a h\u1ECDc th\xE0nh c\xF4ng"})}catch(s){console.error("L\u1ED7i khi tham gia kh\xF3a h\u1ECDc:",s),e.status(500).json({success:!1,message:"\u0110\xE3 x\u1EA3y ra l\u1ED7i khi tham gia kh\xF3a h\u1ECDc"})}};D.updateUserInfo=[ge.single("avatar"),async(t,e)=>{try{let{fullname:s,username:a,email:n,phoneNumber:c,password:o}=t.body,r=await U.findById(t.user.id);if(!r)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ng\u01B0\u1EDDi d\xF9ng"});if(s&&(r.fullname=s),a&&(r.username=a),n&&(r.email=n),c&&(r.phoneNumber=c),o&&(r.password=await Y.hash(o,10)),t.file){if(r.avatar&&r.avatar!=="https://learningwebsite-1.s3.ap-southeast-1.amazonaws.com/user-avatar/default-user-avatar.png"&&r.avatar.includes("amazonaws.com")){let h={Bucket:"learningwebsite-1",Key:r.avatar.split("/").slice(-2).join("/")},_=new le(h);await ps.send(_)}let l=Date.now(),i=pe.extname(t.file.originalname),m=`user-avatar/${r._id}-${l}${i}`,p=gs.readFileSync(t.file.path),d={Bucket:"learningwebsite-1",Key:m,Body:p,ContentType:t.file.mimetype},g=new ie(d);await ps.send(g),r.avatar=`https://${d.Bucket}.s3.${de}.amazonaws.com/${d.Key}`,gs.unlinkSync(t.file.path)}await r.save(),e.status(200).json({success:!0,message:"C\u1EADp nh\u1EADt th\xF4ng tin c\xE1 nh\xE2n th\xE0nh c\xF4ng"})}catch(s){console.error("L\u1ED7i khi c\u1EADp nh\u1EADt th\xF4ng tin c\xE1 nh\xE2n:",s),e.status(500).json({success:!1,message:"\u0110\xE3 x\u1EA3y ra l\u1ED7i khi c\u1EADp nh\u1EADt th\xF4ng tin c\xE1 nh\xE2n"})}}]});var x=f((Ut,fs)=>{var he=require("./node_modules/jsonwebtoken/index.js");require("./node_modules/dotenv/lib/main.js").config();var fe=(t,e,s)=>{let a=t.header("Auth-Token");if(!a)return e.status(401).json({success:!1,message:"Kh\xF4ng c\xF3 token, quy\u1EC1n truy c\u1EADp b\u1ECB t\u1EEB ch\u1ED1i"});try{let n=he.verify(a,process.env.JWT_SECRET);t.user=n,s()}catch{e.status(400).json({success:"false",message:"Token kh\xF4ng h\u1EE3p l\u1EC7"})}};fs.exports=fe});var ws=f((Et,ys)=>{var ye=require("./node_modules/express/index.js"),T=ye.Router(),E=hs(),Q=x();T.post("/register",E.registerUser);T.post("/login",E.loginUser);T.get("/user-info",Q,E.getUserInfo);T.put("/join-course",Q,E.joinCourse);T.put("/update-user-info",Q,E.updateUserInfo);ys.exports=T});var R=f((Nt,_s)=>{var P=require("./node_modules/mongoose/index.js"),we=new P.Schema({course:{type:P.Schema.Types.ObjectId,ref:"Courses"},title:{type:String,required:!0},description:{type:String},type:{type:String,required:!0},url:{type:String},questions:{type:[{question_content:String,options:[String]}]},duration:{type:Number},answers:{type:P.Schema.Types.ObjectId,ref:"Answers"},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});_s.exports=P.model("Assignments",we)});var Is=f(b=>{var w=v(),H=X(),Pt=R(),_e=k(),{S3Client:Rt,PutObjectCommand:bs,DeleteObjectCommand:be}=require("./node_modules/@aws-sdk/client-s3/dist-cjs/index.js"),{s3Client:V,region:G}=K(),je=require("./node_modules/multer/index.js"),J=require("fs"),js=require("path"),Ss=je({dest:"uploads/"});b.getCourses=async(t,e)=>{try{let{pageSize:s,pageNumber:a}=t.body,n=parseInt(s)||10,c=(parseInt(a)-1)*n;c<0&&(c=0);let o=await w.find().limit(n).skip(c).select("-chapters").populate("instructor","fullname avatar"),r=await w.countDocuments();e.status(200).json({success:!0,data:o,totalCourses:r,totalPages:Math.ceil(r/n),currentPage:a})}catch(s){e.status(500).json({success:!1,message:s.message})}};b.getMyCourses=async(t,e)=>{try{let{id:s}=t.user,{coursesJoined:a}=await H.findById(s).select("coursesJoined"),n=await w.find({_id:{$in:a}}).select("-chapters").populate("instructor","fullname avatar"),c=await _e.find({userId:s});n.forEach(o=>{let r=c.find(u=>u.courseId.toString()===o._id.toString());o.progress=r}),e.status(200).json({success:!0,data:n})}catch(s){e.status(500).json({success:!1,message:s.message})}};b.searchCourses=async(t,e)=>{try{let{keyword:s}=t.query;console.log(s);let a=await H.find({fullname:{$regex:s,$options:"i"}}).select("_id"),n=await w.find({$or:[{title:{$regex:s,$options:"i"}},{description:{$regex:s,$options:"i"}},{category:{$regex:s,$options:"i"}},{instructor:{$in:a}}]}).select("-chapters").populate("instructor","fullname avatar");e.status(200).json({success:!0,data:n})}catch(s){e.status(500).json({success:!1,message:s.message})}};b.findCourseByInstrutor=async(t,e)=>{try{let{instructorId:s}=t.params,a=await w.find({instructor:s}).select("-chapters").populate("instructor","fullname avatar");e.status(200).json({success:!0,data:a})}catch(s){e.status(500).json({success:!1,message:s.message})}};b.getCourseDetail=async(t,e)=>{try{let{courseId:s}=t.params,{coursesJoined:a}=await H.findById(t.user.id).select("coursesJoined"),n=await w.findById(s).populate("instructor","fullname avatar").populate({path:"chapters.content.assignment_id",model:"Assignments",select:"type",options:{retainNullValues:!0}});if(!n)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});if(!a.includes(s)&&t.user.role!=="admin"&&t.user.id!==n.instructor.toString())return e.status(403).json({success:!1,message:"Kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp kh\xF3a h\u1ECDc n\xE0y"});e.status(200).json({success:!0,data:n})}catch(s){e.status(500).json({success:!1,message:s.message})}};b.addCourse=[Ss.single("image"),async(t,e)=>{try{let{role:s}=t.user;if(s!=="admin"&&s!=="instructor")return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n th\xEAm kh\xF3a h\u1ECDc"});let{title:a,description:n,price:c,instructor:o}=t.body,r=new w({title:a,description:n,price:c,instructor:o});await r.save();let u=`https://${params.Bucket}.s3.${G}.amazonaws.com/course-image/default-course-image.png`;if(t.file){let l=Date.now(),i=js.extname(t.file.originalname),m=`course-image/${r._id}-${l}${i}`,p=J.readFileSync(t.file.path),d={Bucket:"learningwebsite-1",Key:m,Body:p,ContentType:t.file.mimetype},g=new bs(d);await V.send(g),u=`https://${d.Bucket}.s3.${G}.amazonaws.com/${d.Key}`,J.unlinkSync(t.file.path)}r.image=u,await r.save(),e.status(201).json({success:!0,data:r,message:"Th\xEAm kh\xF3a h\u1ECDc th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}}];b.updateCourse=[Ss.single("image"),async(t,e)=>{try{let{courseId:s}=t.params,a=await w.findById(s);if(!a)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});let{role:n,id:c}=t.user;if(n!=="admin"&&a.instructor.toString()!==c)return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n c\u1EADp nh\u1EADt kh\xF3a h\u1ECDc n\xE0y"});let{title:o,description:r,price:u}=t.body;if(t.file){if(a.image&&a.image.includes("course-image/")){let h={Bucket:"learningwebsite-1",Key:a.image.split("/").slice(-2).join("/")},_=new be(h);await V.send(_)}let l=Date.now(),i=js.extname(t.file.originalname),m=`course-image/${a._id}-${l}${i}`,p=J.readFileSync(t.file.path),d={Bucket:"learningwebsite-1",Key:m,Body:p,ContentType:t.file.mimetype},g=new bs(d);await V.send(g),a.image=`https://${d.Bucket}.s3.${G}.amazonaws.com/${d.Key}`,J.unlinkSync(t.file.path)}a.title=o||a.title,a.description=r||a.description,a.price=u||a.price,await a.save(),e.status(200).json({success:!0,message:"C\u1EADp nh\u1EADt kh\xF3a h\u1ECDc th\xE0nh c\xF4ng",data:a})}catch(s){e.status(500).json({success:!1,message:s.message})}}];b.deleteCourse=async(t,e)=>{try{let{courseId:s}=t.params,a=await w.findById(s);if(!a)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});let{role:n,id:c}=t.user;if(n!=="admin"&&a.instructor.toString()!==c)return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n x\xF3a kh\xF3a h\u1ECDc"});await w.findByIdAndDelete(s),e.status(200).json({success:!0,message:"X\xF3a kh\xF3a h\u1ECDc th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}};b.addChapter=async(t,e)=>{try{let{courseId:s}=t.params,a=await w.findById(s);if(!a)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});let{role:n,id:c}=t.user;if(n!=="admin"&&a.instructor.toString()!==c)return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n th\xEAm ch\u01B0\u01A1ng"});let o=t.body;a.chapters.push(o),a.chapters.forEach((r,u)=>{r.order=u+1}),await a.save(),e.status(201).json({success:!0,data:o,message:"Th\xEAm ch\u01B0\u01A1ng m\u1EDBi th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}};b.updateChapter=async(t,e)=>{try{let{courseId:s,chapterId:a}=t.params,n=await w.findById(s);if(!n)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});let{role:c,id:o}=t.user;if(c!=="admin"&&n.instructor.toString()!==o)return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n c\u1EADp nh\u1EADt ch\u01B0\u01A1ng"});let r=n.chapters.id(a);if(!r)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ch\u01B0\u01A1ng"});let u=t.body;r.set(u),n.chapters.forEach((l,i)=>{l.order=i+1}),await n.save(),e.status(200).json({success:!0,message:"C\u1EADp nh\u1EADt ch\u01B0\u01A1ng th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}};b.deleteChapter=async(t,e)=>{try{let{courseId:s,chapterId:a}=t.params,n=await w.findById(s);if(!n)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});let{role:c,id:o}=t.user;if(c!=="admin"&&n.instructor.toString()!==o)return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n x\xF3a ch\u01B0\u01A1ng"});if(!n.chapters.id(a))return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ch\u01B0\u01A1ng"});n.chapters.pull(a),n.chapters.forEach((u,l)=>{u.order=l+1}),await n.save(),e.status(200).json({success:!0,message:"X\xF3a ch\u01B0\u01A1ng th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}}});var ks=f((zt,Cs)=>{var Se=require("./node_modules/express/index.js"),j=Se.Router(),{getCourses:Ie,getMyCourses:Ce,searchCourses:ke,findCourseByInstrutor:ve,getCourseDetail:xe,addCourse:Be,updateCourse:qe,deleteCourse:$e,addChapter:Ke,updateChapter:De,deleteChapter:Te}=Is(),C=x();j.post("/all-courses",Ie);j.get("/my-courses",C,Ce);j.get("/search-courses",ke);j.get("/find-by-instructor/:instructorId",ve);j.get("/get-detail/:courseId",C,xe);j.post("/add-course",C,Be);j.put("/update-course/:courseId",C,qe);j.delete("/delete-course/:courseId",C,$e);j.post("/add-chapter/:courseId",C,Ke);j.put("/update-chapter/:courseId/:chapterId",C,De);j.delete("/delete-chapter/:courseId/:chapterId",C,Te);Cs.exports=j});var xs=f((Mt,vs)=>{var N=require("./node_modules/mongoose/index.js"),Oe=new N.Schema({course:{type:N.Schema.Types.ObjectId,ref:"Courses"},title:{type:String,required:!0},description:{type:String},type:{type:String,required:!0},url:{type:String},comments:{type:[{userId:{type:N.Schema.Types.ObjectId,ref:"Users"},content:String,create_at:Date,reply:[{userId:{type:N.Schema.Types.ObjectId,ref:"Users"},content:String,create_at:Date}]}],default:[]},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});vs.exports=N.model("Lessons",Oe)});var qs=f(B=>{var Ae=k(),Le=v(),O=xs(),{S3Client:Ft,PutObjectCommand:Ue}=require("./node_modules/@aws-sdk/client-s3/dist-cjs/index.js"),{s3Client:Ee,region:Ne}=K(),Pe=require("./node_modules/multer/index.js"),Bs=require("fs"),Re=require("path"),Je=Pe({dest:"uploads/"});B.getAllLessons=async(t,e)=>{try{if(t.user.role!=="admin"&&t.user.role!=="instructor")return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n xem t\u1EA5t c\u1EA3 b\xE0i h\u1ECDc"});let s=await O.find().select("-comments").sort({create_at:"desc"}).populate("course","course_title");console.log(s),e.status(200).json({success:!0,data:s})}catch(s){e.status(500).json({success:!1,message:s.message})}};B.addLesson=[Je.single("document"),async(t,e)=>{try{let{chapter_number:s,lesson:a}=t.body,{role:n,id:c}=t.user;s=parseInt(s);let o=await Le.findById(a.course);if(!o)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});if(n!=="admin"&&c!==o.instructor.toString())return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n th\xEAm b\xE0i h\u1ECDc"});let r=await O.create(a);if(a.type==="document"&&t.file){let l=Date.now(),i=Re.extname(t.file.originalname),m=`lesson-document/${r._id}-${l}${i}`,p=Bs.readFileSync(t.file.path),d={Bucket:"learningwebsite-1",Key:m,Body:p,ContentType:t.file.mimetype},g=new Ue(d);await Ee.send(g),r.url=`https://${d.Bucket}.s3.${Ne}.amazonaws.com/${d.Key}`,await r.save(),Bs.unlinkSync(t.file.path)}let u=o.chapters.find(l=>l.order===s);if(!u)if(s==o.chapters.length+1||s===o.chapters[o.chapters.length-1].order+1)o.chapters.push({chapter_title:`Ch\u01B0\u01A1ng ${s}`,order:s,content:[]}),u=o.chapters[o.chapters.length-1],(await Ae.find({courseId:o._id})).forEach(i=>{i.progress.push({chapter_order:s,lessons_completed:[],assignments_completed:[],status:"not-started"}),i.save()});else return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ch\u01B0\u01A1ng, h\xE3y t\u1EA1o ch\u01B0\u01A1ng m\u1EDBi"});u.content.push({content_type:"lesson",lesson_id:r._id.toString(),order:u.content.length+1}),await o.save(),e.status(201).json({success:!0,data:r,message:"Th\xEAm b\xE0i h\u1ECDc th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}}];B.getLesson=async(t,e)=>{try{let{role:s,coursesJoined:a,id:n}=t.user,{courseId:c,lessonId:o}=t.params;if(s!=="admin"&&n!==course.instructor.toString()&&!a.includes(c))return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n xem b\xE0i h\u1ECDc"});let r=await O.findById(o).select("-comments").populate("course","course_title");if(!r)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i h\u1ECDc"});e.status(200).json({success:!0,data:r})}catch(s){e.status(500).json({success:!1,message:s.message})}};B.getCommentsOfLesson=async(t,e)=>{try{let{lessonId:s}=t.params,a=await O.findById(s).populate([{path:"comments.userId",select:"fullname avatar"},{path:"comments.reply.userId",select:"fullname avatar"}]);if(!a)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i h\u1ECDc"});e.status(200).json({success:!0,data:a.comments})}catch(s){e.status(500).json({success:!1,message:s.message})}};B.newComment=async(t,e)=>{try{let{lessonId:s,content:a}=t.body,n=await O.findById(s);if(!n)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i h\u1ECDc"});n.comments.push({userId:t.user.id,content:a,create_at:Date.now()}),await n.save(),e.status(201).json({success:!0,message:"Th\xEAm b\xECnh lu\u1EADn th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}};B.replyComment=async(t,e)=>{try{let{lessonId:s,commentId:a,content:n}=t.body,c=await O.findById(s);if(!c)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i h\u1ECDc"});let o=c.comments.id(a);if(!o)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xECnh lu\u1EADn"});o.reply.push({userId:t.user.id,content:n,create_at:Date.now()}),await c.save(),e.status(201).json({success:!0,message:"Tr\u1EA3 l\u1EDDi b\xECnh lu\u1EADn th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}}});var Ks=f((Xt,$s)=>{var ze=require("./node_modules/express/index.js"),q=ze.Router(),{addLesson:Me,getAllLessons:Fe,getLesson:We,getCommentsOfLesson:Xe,newComment:Ye,replyComment:Qe}=qs(),A=x();q.post("/add-lesson",A,Me);q.get("/get-all-lessons",A,Fe);q.get("/get-lesson/:courseId/:lessonId",A,We);q.get("/get-comments-of-lesson/:lessonId",A,Xe);q.post("/new-comment",A,Ye);q.post("/reply-comment",A,Qe);$s.exports=q});var Z=f((Yt,Ts)=>{var Ds=require("./node_modules/mongoose/index.js"),Ve=new Ds.Schema({answer_content:{type:[String]},language:{type:String},version:{type:String},pre_code:{type:String},next_code:{type:String},public_testcases:{type:[{input:String,expected_output:String}]},private_testcases:{type:[{input:String,expected_output:String}]},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});Ts.exports=Ds.model("Answers",Ve)});var Os=f(z=>{var Ge=k(),He=v(),ss=R(),Ze=Z();z.getAllAssignments=async(t,e)=>{try{if(t.user.role!=="admin"&&t.user.role!=="instructor")return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n xem t\u1EA5t c\u1EA3 b\xE0i t\u1EADp"});let s=await ss.find().sort({create_at:"desc"}).populate("course","course_title");e.status(200).json({success:!0,data:s})}catch(s){e.status(500).json({success:!1,message:s.message})}};z.addAssignment=async(t,e)=>{try{let{chapter_number:s,assignment:a}=t.body,{role:n,id:c}=t.user;s=parseInt(s);let o=await He.findById(a.course);if(!o)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});if(n!=="admin"&&c!==o.instructor.toString())return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n th\xEAm b\xE0i t\u1EADp"});let r=await Ze.create(a.answers);a.answers=r._id;let u=await ss.create(a),l=o.chapters.find(i=>i.order===s);if(!l)if(s==o.chapters.length+1||s===o.chapters[o.chapters.length-1].order+1)o.chapters.push({chapter_title:`Ch\u01B0\u01A1ng ${s}`,order:s,content:[]}),l=o.chapters[o.chapters.length-1],(await Ge.find({courseId:o._id})).forEach(m=>{m.progress.push({chapter_order:s,lessons_completed:[],assignments_completed:[],status:"not-started"}),m.save()});else return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ch\u01B0\u01A1ng, h\xE3y t\u1EA1o ch\u01B0\u01A1ng m\u1EDBi"});l.content.push({content_type:"assignment",assignment_id:u._id.toString(),order:l.content.length+1}),await o.save(),e.status(201).json({success:!0,data:u})}catch(s){e.status(500).json({success:!1,message:s.message})}};z.getAssignmentById=async(t,e)=>{try{let{id:s}=t.params,{role:a}=t.user,n=ss.findById(s).populate("course","course_title");(a==="admin"||a==="instructor")&&(n=n.populate("answers"));let c=await n;if(!c)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i t\u1EADp"});e.status(200).json({success:!0,data:c})}catch(s){e.status(500).json({success:!1,message:s.message})}}});var Ls=f((Vt,As)=>{var st=require("./node_modules/express/index.js"),M=st.Router(),{getAllAssignments:et,addAssignment:tt,getAssignmentById:nt}=Os(),es=x();M.get("/get-all-assignments",es,et);M.post("/add-assignment",es,tt);M.get("/get-assignment/:id",es,nt);As.exports=M});var Es=f((Gt,Us)=>{var F=require("./node_modules/mongoose/index.js"),at=new F.Schema({assignmentId:{type:F.Schema.Types.ObjectId,ref:"Assignments"},userId:{type:F.Schema.Types.ObjectId,ref:"Users"},submission_detail:{type:[{content:[String],testcases:{public:[{input:String,expected_output:String,output:String,status:String}],private:[{status:String,input:String,your_output:String}]},submit_at:{type:Date,default:Date.now},score:Number}]},highest_score:{type:Number},submit_count:{type:Number,default:0}});Us.exports=F.model("Submissions",at)});var zs=f(as=>{var I=Es(),ot=R(),Ns=Z(),rt=v(),Ps=k(),{S3Client:Ht,PutObjectCommand:ct,DeleteObjectCommand:Zt}=require("./node_modules/@aws-sdk/client-s3/dist-cjs/index.js"),{s3Client:ut,region:it}=K(),lt=require("./node_modules/multer/index.js"),Rs=require("fs"),sn=require("path"),dt=lt({dest:"uploads/"}),mt=require("./node_modules/axios/dist/node/axios.cjs");async function Js(t,e,s,a=""){let n=a.split(" "),c={language:t,version:e,files:[{name:"main",content:s}],stdin:t==="c++"||t==="python"?a:null,args:t==="javascript"?n:null,compile_timeout:1e4,run_timeout:5e3,compile_memory_limit:-1,run_memory_limit:-1};try{return(await mt.post("https://emkc.org/api/v2/piston/execute",c,{headers:{"Content-Type":"application/json"}})).data.run.stdout}catch(o){return console.error("L\u1ED7i:",o.response?o.response.data:o.message),null}}async function pt(t,e,s,a,n){let c=0,o={score:0,testcases:{public:[],private:[]}};for(let[r,u]of s.entries()){let l=await Js(t,e,n,u.input);l===u.expected_output?(console.log(`Testcase ${r+1}: \u0110\xFAng`),c++,o.testcases.public.push({input:u.input,expected_output:u.expected_output,output:l,status:"correct"})):(console.log(`Testcase ${r+1}: Sai (\u0110\u1EA7u ra: ${l}, K\u1EF3 v\u1ECDng: ${u.expected_output})`),o.testcases.public.push({input:u.input,expected_output:u.expected_output,output:l,status:"wrong"}))}if(c!=s.length)return o;for(let[r,u]of a.entries()){let l=await Js(t,e,n,u.input);l===u.expected_output?(console.log(`Testcase ${r+1}: \u0110\xFAng`),c++,o.testcases.private.push({status:"correct",input:u.input,your_output:l})):(console.log(`Testcase ${r+1}: Sai (\u0110\u1EA7u ra: ${l}, K\u1EF3 v\u1ECDng: ${u.expected_output})`),o.testcases.private.push({status:"wrong",input:u.input,your_output:l}))}return console.log(`
K\u1EBFt qu\u1EA3: ${c}/${s.length+a.length} testcase \u0111\xFAng`),o.score=c/(s.length+a.length)*10,o}function ts(t,e){let s=t.progress.length;for(;s<e;)t.progress.push({chapter_order:s,assignments_completed:[],status:"in-progress"}),s++;t.save()}function ns(t,e,s,a){t.progress[e-1].assignments_completed.indexOf(s)===-1&&t.progress[e-1].assignments_completed.push(s),t.progress[e-1].status==="not-started"&&(t.progress[e-1].status="in-progress"),t.progress[e-1].assignments_completed.length+t.progress[e-1].lessons_completed.length===a.chapters[e-1].content.length&&(t.progress[e-1].status="completed")}as.addSubmission=async(t,e)=>{try{let{id:s}=t.user;dt.fields([{name:"file",maxCount:1},{name:"assignmentId",maxCount:1}])(t,e,async a=>{if(a)return e.status(500).json({success:!1,message:a.message});let{assignmentId:n,courseId:c}=t.body,o=await ot.findById(n),r=await rt.findById(c),u=await Ps.findOne({userId:s,courseId:c});u||(u=await Ps.create({userId:s,courseId:c,progress:r.chapters.map(i=>({chapter_id:i._id,status:"not-started",lessons_completed:[],assignments_completed:[]}))}));let l=-1;for(let i of r.chapters)if(i.content.some(p=>p.assignment_id&&p.assignment_id.toString()===n)){l=i.order;break}if(!o)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i t\u1EADp t\u01B0\u01A1ng \u1EE9ng"});if(console.log("Type: "+o.type),o.type==="quiz"||o.type==="fill"){let i={},m=await Ns.findById(o.answers),{submission_content:p}=t.body,d=await I.findOne({assignmentId:n,userId:s}),g=0;for(let h=0;h<p.length;h++)m.answer_content[h].toLowerCase()===p[h]&&g++;let y=g/m.answer_content.length*10;if(d){if(d.submit_count>10)return e.status(400).json({success:!1,message:"B\u1EA1n \u0111\xE3 n\u1ED9p b\xE0i qu\xE1 10 l\u1EA7n"});let h=0;if(d.submit_count++,!m)return d.submission_detail.push({content:p}),e.status(200).json({success:!0,message:"\u0110\xE3 n\u1ED9p b\xE0i nh\u01B0ng ch\u01B0a c\xF3 \u0111\xE1p \xE1n, h\xE3y ch\u1EDD th\u1EA7y gi\xE1o ch\u1EA5m!"});for(let _=0;_<p.length;_++)m.answer_content[_]===p[_]&&h++;(!d.highest_score||y>d.highest_score)&&(d.highest_score=h),d.submission_detail.push({content:p,score:y}),await d.save(),console.log(1),i=d,console.log("existedSubmission: "+i)}else{if(!m)return(await I.create({assignmentId:n,userId:s,submit_count:1,submission_detail:[{content:p}]})).save(),e.status(200).json({success:!0,message:"\u0110\xE3 n\u1ED9p b\xE0i nh\u01B0ng ch\u01B0a c\xF3 \u0111\xE1p \xE1n, h\xE3y ch\u1EDD th\u1EA7y gi\xE1o ch\u1EA5m!"});let h=await I.create({assignmentId:n,userId:s,submit_count:1,submission_detail:[{content:p,score:y}],highest_score:y});h.save(),i=h}return y>=7&&(ts(u,l),ns(u,l,n,r)),console.log("Submission: "+i),e.status(200).json({success:!0,data:i})}else if(o.type==="code"){let i=await Ns.findById(o.answers),{submission_content:m}=t.body;console.log("content: "+m);let p=`
${i.pre_code}
${m}
${i.next_code}
`;console.log(p);let d=await pt(i.language,i.version,i.public_testcases,i.private_testcases,p);console.log("Public length:"+d.testcases.public.length),console.log("Private length:"+d.testcases.private.length);let g=await I.findOne({assignmentId:n,userId:s});if(g)return g.submit_count>20?e.status(400).json({success:!1,message:"B\u1EA1n \u0111\xE3 n\u1ED9p b\xE0i qu\xE1 20 l\u1EA7n"}):(g.submit_count++,g.submission_detail.unshift({content:m,testcases:d.testcases,score:d.score}),(!g.highest_score||d.score>g.highest_score)&&(g.highest_score=d.score),ts(u,l),d.score>=7&&ns(u,l,n,r),await g.save(),e.status(200).json({success:!0,data:g}));{let y=await I.create({assignmentId:n,userId:s,submit_count:1,submission_detail:[{content:m,testcases:d.testcases,score:d.score}],highest_score:d.score});return ts(u,l),d.score>=7&&ns(u,l,n,r),y.save(),e.status(201).json({success:!0,data:y})}}else if(o.type==="plaintext"){let{submission_content:i}=t.body,m=await I.findOne({assignmentId:n,userId:s});if(m)return m.submit_count>10?e.status(400).json({success:!1,message:"B\u1EA1n \u0111\xE3 n\u1ED9p b\xE0i qu\xE1 10 l\u1EA7n"}):(m.submit_count++,m.submission_detail.push({content:i}),await m.save(),e.status(200).json({success:!0,data:m}));{let p=await I.create({assignmentId:n,userId:s,submit_count:1,submission_detail:[{content:i}]});return p.save(),e.status(201).json({success:!0,data:p})}}else if(o.type==="file-upload"){let i=t.files.file[0],m=Rs.readFileSync(i.path),p="learningwebsite-1",d=`submission-upload/${s}`,g={Bucket:p,Key:`${d}/${i.originalname}`,Body:m,ContentType:i.mimetype};try{await ut.send(new ct(g)),Rs.unlinkSync(i.path);let y=`https://${p}.s3.${it}.amazonaws.com/${d}/${i.originalname}`,h=await I.findOne({assignmentId:n,userId:s});if(h)return h.submit_count>10?e.status(400).json({success:!1,message:"B\u1EA1n \u0111\xE3 n\u1ED9p b\xE0i qu\xE1 10 l\u1EA7n"}):(h.submit_count++,h.submission_detail.push({content:y}),await h.save(),e.status(200).json({success:!0,data:h}));{let _=await I.create({assignmentId:n,userId:s,submit_count:1,submission_detail:[{content:y}]});return await _.save(),e.status(201).json({success:!0,data:_})}}catch(y){return e.status(500).json({success:!1,message:y.message})}}})}catch(s){e.status(500).json({success:!1,message:s.message})}};as.getSubmission=async(t,e)=>{try{let{id:s}=t.user,{assignmentId:a}=t.params,n=await I.findOne({assignmentId:a,userId:s});return n?e.status(200).json({success:!0,data:n}):e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i n\u1ED9p t\u01B0\u01A1ng \u1EE9ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}}});var Ws=f((tn,Fs)=>{var gt=require("./node_modules/express/index.js"),os=gt.Router(),{addSubmission:ht,getSubmission:ft}=zs(),Ms=x();os.post("/add-submission",Ms,ht);os.get("/get-submission/:assignmentId",Ms,ft);Fs.exports=os});var Xs=f(cs=>{var rs=k(),yt=v();cs.getCourseProgress=async(t,e)=>{try{let{courseId:s}=t.params,{id:a}=t.user,n=await rs.findOne({userId:a,courseId:s});return n?e.status(200).json({success:!0,data:n}):e.status(404).json({success:!1,message:"Course progress not found"})}catch(s){e.status(500).json({success:!1,message:s.message})}};cs.completeLesson=async(t,e)=>{try{let{courseId:s,lessonId:a}=t.params,{id:n}=t.user,c=await rs.findOne({userId:n,courseId:s}),o=await yt.findById(s);c||(c=await rs.create({userId:n,courseId:s,progress:o.chapters.map(u=>({chapter_id:u._id,status:"not-started",lessons_completed:[],assignments_completed:[]}))}));let r=o.chapters.find(u=>u.content.find(l=>l.lesson_id.toString()===a.toString())).order;return o.chapters[r-1].content.find(u=>u.lesson_id.toString()===a.toString())===void 0?e.status(404).json({success:!1,message:"Lesson not found"}):c.progress[r-1].lessons_completed.includes(a)?e.status(400).json({success:!1,message:"Lesson already completed"}):(c.progress[r-1].lessons_completed.push(a),c.progress[r-1].status==="not-started"&&(c.progress[r-1].status="in-progress"),c.progress[r-1].assignments_completed.length+c.progress[r-1].lessons_completed.length===o.chapters[r-1].content.length&&(c.progress[r-1].status="completed"),await c.save(),e.status(200).json({success:!0,message:"Lesson completed"}))}catch(s){e.status(500).json({success:!1,message:s.message})}}});var Vs=f((an,Qs)=>{var wt=require("./node_modules/express/index.js"),us=wt.Router(),{getCourseProgress:_t,completeLesson:bt}=Xs(),Ys=x();us.get("/get-course-progress/:courseId",Ys,_t);us.put("/complete-lesson/:courseId/:lessonId",Ys,bt);Qs.exports=us});var Hs=require("./node_modules/express/index.js"),Zs=require("./node_modules/body-parser/index.js"),jt=require("path"),St=require("./node_modules/cors/lib/index.js");require("./node_modules/dotenv/lib/main.js").config();var It=ws(),Ct=ks(),kt=Ks(),vt=Ls(),xt=Ws(),Bt=Vs(),on=K(),qt=process.env.DB_URI,$t=require("./node_modules/mongoose/index.js");$t.connect(qt,null).then(()=>{console.log("MongoDB connection successful...")}).catch(t=>{console.log("MongoDB connection failed",t.message)});var S=Hs();S.use(Hs.static(jt.join(__dirname)));S.use(St());S.use(Zs.urlencoded({extended:!1}));S.use(Zs.json());S.use("/user",It);S.use("/course",Ct);S.use("/lesson",kt);S.use("/assignment",vt);S.use("/submission",xt);S.use("/progress",Bt);var Gs=process.env.PORT||3e3;S.listen(Gs,()=>{console.log(`Server \u0111ang ch\u1EA1y t\u1EA1i http://localhost:${Gs}`)});
