var p=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var X=p((kt,is)=>{var F=require("./node_modules/mongoose/index.js"),Zs=new F.Schema({fullname:{type:String,required:!0},username:{type:String,required:!0,unique:!0},email:{type:String,unique:!0},phoneNumber:{type:String,unique:!0},password:{type:String,required:!0},role:{type:String,default:"user"},avatar:{type:String,default:"https://learningwebsite-1.s3.ap-southeast-1.amazonaws.com/user-avatar/default-user-avatar.png"},coursesJoined:{type:[F.Schema.Types.ObjectId],ref:"Courses"},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});is.exports=F.model("Users",Zs)});var S=p((vt,ls)=>{var x=require("./node_modules/mongoose/index.js"),se=new x.Schema({userId:{type:x.Schema.Types.ObjectId,ref:"Users"},courseId:{type:x.Schema.Types.ObjectId,ref:"Courses"},progress:{type:[{chapter_order:Number,lessons_completed:[x.Schema.Types.ObjectId],assignments_completed:[x.Schema.Types.ObjectId],status:{type:String,enum:["completed","in-progress","not-started"],default:"not-started"}}],default:[]},last_update:{type:Date,default:Date.now}});ls.exports=x.model("CourseProgresses",se)});var I=p((xt,ds)=>{var T=require("./node_modules/mongoose/index.js"),ee=new T.Schema({title:{type:String,required:!0},description:{type:String},price:{type:Number},image:{type:String},instructor:{type:T.Schema.Types.ObjectId,ref:"Users"},category:{type:[String]},chapters:{type:[{chapter_title:String,order:Number,content:[{content_type:String,lesson_id:T.Schema.Types.ObjectId,assignment_id:{type:T.Schema.Types.ObjectId,ref:"Assignments"},order:Number}]}]},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});ds.exports=T.model("Courses",ee)});var A=p((Bt,ms)=>{var{S3Client:te}=require("./node_modules/@aws-sdk/client-s3/dist-cjs/index.js");require("./node_modules/dotenv/lib/main.js").config();var ne=new te({region:"ap-southeast-1",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY}}),ae="ap-southeast-1";ms.exports={s3Client:ne,region:ae}});var hs=p(B=>{var O=X(),oe=S(),re=I(),Y=require("./node_modules/bcrypt/bcrypt.js"),ce=require("./node_modules/jsonwebtoken/index.js"),{PutObjectCommand:ue,DeleteObjectCommand:ie}=require("./node_modules/@aws-sdk/client-s3/dist-cjs/index.js"),{s3Client:gs,region:le}=A(),de=require("./node_modules/multer/index.js"),ps=require("fs"),me=require("path"),ge=de({dest:"uploads/"});B.registerUser=async(t,e)=>{try{let{fullname:s,username:n,email:a,phoneNumber:c,password:o,role:r,avatar:u,create_at:i}=t.body,d=await Y.hash(o,10);await new O({fullname:s,username:n,email:a,phoneNumber:c,password:d,role:r,avatar:u,create_at:i}).save(),e.status(201).json({success:!0,message:"\u0110\u0103ng k\xFD t\xE0i kho\u1EA3n th\xE0nh c\xF4ng!"})}catch(s){e.status(500).json({success:!1,message:s.message})}};B.loginUser=async(t,e)=>{try{let{identifier:s,password:n}=t.body,a=await O.findOne({$or:[{username:s},{email:s},{phoneNumber:s}]});if(!a)return e.status(400).json({success:!1,message:"T\xE0i kho\u1EA3n kh\xF4ng t\u1ED3n t\u1EA1i"});if(!await Y.compare(n,a.password))return e.status(400).json({success:!1,message:"M\u1EADt kh\u1EA9u kh\xF4ng ch\xEDnh x\xE1c"});let o=ce.sign({id:a._id,username:a.username,fullname:a.fullname,email:a.email,phoneNumber:a.phoneNumber,password:a.password,role:a.role,coursesJoined:a.coursesJoined,avatar:a.avatar,create_at:a.create_at},process.env.JWT_SECRET,{expiresIn:process.env.JWT_EXPIRES_IN});e.status(200).json({success:!0,token:o})}catch(s){console.error("L\u1ED7i khi \u0111\u0103ng nh\u1EADp:",s),e.status(500).json({success:!1,message:"\u0110\xE3 x\u1EA3y ra l\u1ED7i khi \u0111\u0103ng nh\u1EADp"})}};B.getUserInfo=async(t,e)=>{try{let s=await O.findById(t.user.id).select("-password");if(!s)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ng\u01B0\u1EDDi d\xF9ng"});e.status(200).json({success:!0,user:s})}catch(s){console.error("L\u1ED7i khi l\u1EA5y th\xF4ng tin ng\u01B0\u1EDDi d\xF9ng:",s),e.status(500).json({success:!1,message:"\u0110\xE3 x\u1EA3y ra l\u1ED7i khi l\u1EA5y th\xF4ng tin ng\u01B0\u1EDDi d\xF9ng"})}};B.joinCourse=async(t,e)=>{try{if(!t.body||t.body===void 0||t.body===""||t.body===null)return e.status(400).json({success:!1,message:"Thi\u1EBFu th\xF4ng tin kh\xF3a h\u1ECDc"});let{courseId:s}=t.body;if(!s||s===void 0||s===""||s===null)return e.status(400).json({success:!1,message:"Thi\u1EBFu th\xF4ng tin kh\xF3a h\u1ECDc"});let n=await O.findById(t.user.id);if(!n)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ng\u01B0\u1EDDi d\xF9ng"});if(n.coursesJoined.includes(s))return e.status(400).json({success:!1,message:"B\u1EA1n \u0111\xE3 tham gia kh\xF3a h\u1ECDc n\xE0y r\u1ED3i"});n.coursesJoined.push(s),await n.save();let a=await re.findById(s),c=new oe({userId:t.user.id,courseId:s});a.chapters.forEach(o=>{c.progress.push({chapter_order:o.order,lessons_completed:[],assignments_completed:[]})}),await c.save(),e.status(200).json({success:!0,message:"Tham gia kh\xF3a h\u1ECDc th\xE0nh c\xF4ng"})}catch(s){console.error("L\u1ED7i khi tham gia kh\xF3a h\u1ECDc:",s),e.status(500).json({success:!1,message:"\u0110\xE3 x\u1EA3y ra l\u1ED7i khi tham gia kh\xF3a h\u1ECDc"})}};B.updateUserInfo=[ge.single("avatar"),async(t,e)=>{try{let{fullname:s,username:n,email:a,phoneNumber:c,password:o}=t.body,r=await O.findById(t.user.id);if(!r)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ng\u01B0\u1EDDi d\xF9ng"});if(s&&(r.fullname=s),n&&(r.username=n),a&&(r.email=a),c&&(r.phoneNumber=c),o&&(r.password=await Y.hash(o,10)),t.file){if(r.avatar&&r.avatar!=="https://learningwebsite-1.s3.ap-southeast-1.amazonaws.com/user-avatar/default-user-avatar.png"&&r.avatar.includes("amazonaws.com")){let E={Bucket:"learningwebsite-1",Key:r.avatar.split("/").slice(-2).join("/")},W=new ie(E);await gs.send(W)}let i=Date.now(),d=me.extname(t.file.originalname),g=`user-avatar/${r._id}-${i}${d}`,l=ps.readFileSync(t.file.path),m={Bucket:"learningwebsite-1",Key:g,Body:l,ContentType:t.file.mimetype},h=new ue(m);await gs.send(h),r.avatar=`https://${m.Bucket}.s3.${le}.amazonaws.com/${m.Key}`,ps.unlinkSync(t.file.path)}await r.save(),e.status(200).json({success:!0,message:"C\u1EADp nh\u1EADt th\xF4ng tin c\xE1 nh\xE2n th\xE0nh c\xF4ng"})}catch(s){console.error("L\u1ED7i khi c\u1EADp nh\u1EADt th\xF4ng tin c\xE1 nh\xE2n:",s),e.status(500).json({success:!1,message:"\u0110\xE3 x\u1EA3y ra l\u1ED7i khi c\u1EADp nh\u1EADt th\xF4ng tin c\xE1 nh\xE2n"})}}]});var C=p(($t,fs)=>{var pe=require("./node_modules/jsonwebtoken/index.js");require("./node_modules/dotenv/lib/main.js").config();var he=(t,e,s)=>{let n=t.header("Auth-Token");if(!n)return e.status(401).json({success:!1,message:"Kh\xF4ng c\xF3 token, quy\u1EC1n truy c\u1EADp b\u1ECB t\u1EEB ch\u1ED1i"});try{let a=pe.verify(n,process.env.JWT_SECRET);t.user=a,s()}catch{e.status(400).json({success:"false",message:"Token kh\xF4ng h\u1EE3p l\u1EC7"})}};fs.exports=he});var ws=p((Kt,ys)=>{var fe=require("./node_modules/express/index.js"),q=fe.Router(),L=hs(),Q=C();q.post("/register",L.registerUser);q.post("/login",L.loginUser);q.get("/user-info",Q,L.getUserInfo);q.put("/join-course",Q,L.joinCourse);q.put("/update-user-info",Q,L.updateUserInfo);ys.exports=q});var P=p((Dt,_s)=>{var N=require("./node_modules/mongoose/index.js"),ye=new N.Schema({course:{type:N.Schema.Types.ObjectId,ref:"Courses"},title:{type:String,required:!0},description:{type:String},type:{type:String,required:!0},url:{type:String},questions:{type:[{question_content:String,options:[String]}]},duration:{type:Number},answers:{type:N.Schema.Types.ObjectId,ref:"Answers"},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});_s.exports=N.model("Assignments",ye)});var Is=p(y=>{var f=I(),H=X(),Tt=P(),we=S(),{S3Client:At,PutObjectCommand:js,DeleteObjectCommand:_e}=require("./node_modules/@aws-sdk/client-s3/dist-cjs/index.js"),{s3Client:V,region:G}=A(),je=require("./node_modules/multer/index.js"),R=require("fs"),bs=require("path"),Ss=je({dest:"uploads/"});y.getCourses=async(t,e)=>{try{let{pageSize:s,pageNumber:n}=t.body,a=parseInt(s)||10,c=(parseInt(n)-1)*a;c<0&&(c=0);let o=await f.find().limit(a).skip(c).select("-chapters").populate("instructor","fullname avatar"),r=await f.countDocuments();e.status(200).json({success:!0,data:o,totalCourses:r,totalPages:Math.ceil(r/a),currentPage:n})}catch(s){e.status(500).json({success:!1,message:s.message})}};y.getMyCourses=async(t,e)=>{try{let{id:s}=t.user,{coursesJoined:n}=await H.findById(s).select("coursesJoined"),a=await f.find({_id:{$in:n}}).select("-chapters").populate("instructor","fullname avatar"),c=await we.find({userId:s});a.forEach(o=>{let r=c.find(u=>u.courseId.toString()===o._id.toString());o.progress=r}),e.status(200).json({success:!0,data:a})}catch(s){e.status(500).json({success:!1,message:s.message})}};y.searchCourses=async(t,e)=>{try{let{keyword:s}=t.query;console.log(s);let n=await H.find({fullname:{$regex:s,$options:"i"}}).select("_id"),a=await f.find({$or:[{title:{$regex:s,$options:"i"}},{description:{$regex:s,$options:"i"}},{category:{$regex:s,$options:"i"}},{instructor:{$in:n}}]}).select("-chapters").populate("instructor","fullname avatar");e.status(200).json({success:!0,data:a})}catch(s){e.status(500).json({success:!1,message:s.message})}};y.getCourseDetail=async(t,e)=>{try{let{courseId:s}=t.params,{coursesJoined:n}=await H.findById(t.user.id).select("coursesJoined"),a=await f.findById(s).populate("instructor","fullname avatar").populate({path:"chapters.content.assignment_id",model:"Assignments",select:"type",options:{retainNullValues:!0}});if(!a)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});if(!n.includes(s)&&t.user.role!=="admin"&&t.user.id!==a.instructor.toString())return e.status(403).json({success:!1,message:"Kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp kh\xF3a h\u1ECDc n\xE0y"});e.status(200).json({success:!0,data:a})}catch(s){e.status(500).json({success:!1,message:s.message})}};y.addCourse=[Ss.single("image"),async(t,e)=>{try{let{role:s}=t.user;if(s!=="admin"&&s!=="instructor")return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n th\xEAm kh\xF3a h\u1ECDc"});let{title:n,description:a,price:c,instructor:o}=t.body,r=new f({title:n,description:a,price:c,instructor:o});await r.save();let u=`https://${params.Bucket}.s3.${G}.amazonaws.com/course-image/default-course-image.png`;if(t.file){let i=Date.now(),d=bs.extname(t.file.originalname),g=`course-image/${r._id}-${i}${d}`,l=R.readFileSync(t.file.path),m={Bucket:"learningwebsite-1",Key:g,Body:l,ContentType:t.file.mimetype},h=new js(m);await V.send(h),u=`https://${m.Bucket}.s3.${G}.amazonaws.com/${m.Key}`,R.unlinkSync(t.file.path)}r.image=u,await r.save(),e.status(201).json({success:!0,data:r,message:"Th\xEAm kh\xF3a h\u1ECDc th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}}];y.updateCourse=[Ss.single("image"),async(t,e)=>{try{let{courseId:s}=t.params,n=await f.findById(s);if(!n)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});let{role:a,id:c}=t.user;if(a!=="admin"&&n.instructor.toString()!==c)return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n c\u1EADp nh\u1EADt kh\xF3a h\u1ECDc n\xE0y"});let{title:o,description:r,price:u}=t.body;if(t.file){if(n.image&&n.image.includes("course-image/")){let E={Bucket:"learningwebsite-1",Key:n.image.split("/").slice(-2).join("/")},W=new _e(E);await V.send(W)}let i=Date.now(),d=bs.extname(t.file.originalname),g=`course-image/${n._id}-${i}${d}`,l=R.readFileSync(t.file.path),m={Bucket:"learningwebsite-1",Key:g,Body:l,ContentType:t.file.mimetype},h=new js(m);await V.send(h),n.image=`https://${m.Bucket}.s3.${G}.amazonaws.com/${m.Key}`,R.unlinkSync(t.file.path)}n.title=o||n.title,n.description=r||n.description,n.price=u||n.price,await n.save(),e.status(200).json({success:!0,message:"C\u1EADp nh\u1EADt kh\xF3a h\u1ECDc th\xE0nh c\xF4ng",data:n})}catch(s){e.status(500).json({success:!1,message:s.message})}}];y.deleteCourse=async(t,e)=>{try{let{courseId:s}=t.params,n=await f.findById(s);if(!n)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});let{role:a,id:c}=t.user;if(a!=="admin"&&n.instructor.toString()!==c)return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n x\xF3a kh\xF3a h\u1ECDc"});await f.findByIdAndDelete(s),e.status(200).json({success:!0,message:"X\xF3a kh\xF3a h\u1ECDc th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}};y.addChapter=async(t,e)=>{try{let{courseId:s}=t.params,n=await f.findById(s);if(!n)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});let{role:a,id:c}=t.user;if(a!=="admin"&&n.instructor.toString()!==c)return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n th\xEAm ch\u01B0\u01A1ng"});let o=t.body;n.chapters.push(o),n.chapters.forEach((r,u)=>{r.order=u+1}),await n.save(),e.status(201).json({success:!0,data:o,message:"Th\xEAm ch\u01B0\u01A1ng m\u1EDBi th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}};y.updateChapter=async(t,e)=>{try{let{courseId:s,chapterId:n}=t.params,a=await f.findById(s);if(!a)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});let{role:c,id:o}=t.user;if(c!=="admin"&&a.instructor.toString()!==o)return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n c\u1EADp nh\u1EADt ch\u01B0\u01A1ng"});let r=a.chapters.id(n);if(!r)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ch\u01B0\u01A1ng"});let u=t.body;r.set(u),a.chapters.forEach((i,d)=>{i.order=d+1}),await a.save(),e.status(200).json({success:!0,message:"C\u1EADp nh\u1EADt ch\u01B0\u01A1ng th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}};y.deleteChapter=async(t,e)=>{try{let{courseId:s,chapterId:n}=t.params,a=await f.findById(s);if(!a)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});let{role:c,id:o}=t.user;if(c!=="admin"&&a.instructor.toString()!==o)return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n x\xF3a ch\u01B0\u01A1ng"});if(!a.chapters.id(n))return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ch\u01B0\u01A1ng"});a.chapters.pull(n),a.chapters.forEach((u,i)=>{u.order=i+1}),await a.save(),e.status(200).json({success:!0,message:"X\xF3a ch\u01B0\u01A1ng th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}}});var ks=p((Lt,Cs)=>{var be=require("./node_modules/express/index.js"),w=be.Router(),{getCourses:Se,getMyCourses:Ie,searchCourses:Ce,getCourseDetail:ke,addCourse:ve,updateCourse:xe,deleteCourse:Be,addChapter:qe,updateChapter:$e,deleteChapter:Ke}=Is(),b=C();w.post("/all-courses",Se);w.get("/my-courses",b,Ie);w.get("/search-courses",Ce);w.get("/get-detail/:courseId",b,ke);w.post("/add-course",b,ve);w.put("/update-course/:courseId",b,xe);w.delete("/delete-course/:courseId",b,Be);w.post("/add-chapter/:courseId",b,qe);w.put("/update-chapter/:courseId/:chapterId",b,$e);w.delete("/delete-chapter/:courseId/:chapterId",b,Ke);Cs.exports=w});var xs=p((Ut,vs)=>{var U=require("./node_modules/mongoose/index.js"),De=new U.Schema({course:{type:U.Schema.Types.ObjectId,ref:"Courses"},title:{type:String,required:!0},description:{type:String},type:{type:String,required:!0},url:{type:String},comments:{type:[{userId:{type:U.Schema.Types.ObjectId,ref:"Users"},content:String,create_at:Date,reply:[{userId:{type:U.Schema.Types.ObjectId,ref:"Users"},content:String,create_at:Date}]}],default:[]},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});vs.exports=U.model("Lessons",De)});var qs=p(k=>{var Te=S(),Ae=I(),$=xs(),{S3Client:Et,PutObjectCommand:Oe}=require("./node_modules/@aws-sdk/client-s3/dist-cjs/index.js"),{s3Client:Le,region:Ue}=A(),Ee=require("./node_modules/multer/index.js"),Bs=require("fs"),Ne=require("path"),Pe=Ee({dest:"uploads/"});k.getAllLessons=async(t,e)=>{try{if(t.user.role!=="admin"&&t.user.role!=="instructor")return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n xem t\u1EA5t c\u1EA3 b\xE0i h\u1ECDc"});let s=await $.find().select("-comments").sort({create_at:"desc"}).populate("course","course_title");console.log(s),e.status(200).json({success:!0,data:s})}catch(s){e.status(500).json({success:!1,message:s.message})}};k.addLesson=[Pe.single("document"),async(t,e)=>{try{let{chapter_number:s,lesson:n}=t.body,{role:a,id:c}=t.user;s=parseInt(s);let o=await Ae.findById(n.course);if(!o)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});if(a!=="admin"&&c!==o.instructor.toString())return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n th\xEAm b\xE0i h\u1ECDc"});let r=await $.create(n);if(n.type==="document"&&t.file){let i=Date.now(),d=Ne.extname(t.file.originalname),g=`lesson-document/${r._id}-${i}${d}`,l=Bs.readFileSync(t.file.path),m={Bucket:"learningwebsite-1",Key:g,Body:l,ContentType:t.file.mimetype},h=new Oe(m);await Le.send(h),r.url=`https://${m.Bucket}.s3.${Ue}.amazonaws.com/${m.Key}`,await r.save(),Bs.unlinkSync(t.file.path)}let u=o.chapters.find(i=>i.order===s);if(!u)if(s==o.chapters.length+1||s===o.chapters[o.chapters.length-1].order+1)o.chapters.push({chapter_title:`Ch\u01B0\u01A1ng ${s}`,order:s,content:[]}),u=o.chapters[o.chapters.length-1],(await Te.find({courseId:o._id})).forEach(d=>{d.progress.push({chapter_order:s,lessons_completed:[],assignments_completed:[],status:"not-started"}),d.save()});else return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ch\u01B0\u01A1ng, h\xE3y t\u1EA1o ch\u01B0\u01A1ng m\u1EDBi"});u.content.push({content_type:"lesson",lesson_id:r._id.toString(),order:u.content.length+1}),await o.save(),e.status(201).json({success:!0,data:r,message:"Th\xEAm b\xE0i h\u1ECDc th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}}];k.getLesson=async(t,e)=>{try{let{role:s,coursesJoined:n,id:a}=t.user,{courseId:c,lessonId:o}=t.params;if(s!=="admin"&&a!==course.instructor.toString()&&!n.includes(c))return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n xem b\xE0i h\u1ECDc"});let r=await $.findById(o).select("-comments").populate("course","course_title");if(!r)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i h\u1ECDc"});e.status(200).json({success:!0,data:r})}catch(s){e.status(500).json({success:!1,message:s.message})}};k.getCommentsOfLesson=async(t,e)=>{try{let{lessonId:s}=t.params,n=await $.findById(s).populate([{path:"comments.userId",select:"fullname avatar"},{path:"comments.reply.userId",select:"fullname avatar"}]);if(!n)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i h\u1ECDc"});e.status(200).json({success:!0,data:n.comments})}catch(s){e.status(500).json({success:!1,message:s.message})}};k.newComment=async(t,e)=>{try{let{lessonId:s,content:n}=t.body,a=await $.findById(s);if(!a)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i h\u1ECDc"});a.comments.push({userId:t.user.id,content:n,create_at:Date.now()}),await a.save(),e.status(201).json({success:!0,message:"Th\xEAm b\xECnh lu\u1EADn th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}};k.replyComment=async(t,e)=>{try{let{lessonId:s,commentId:n,content:a}=t.body,c=await $.findById(s);if(!c)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i h\u1ECDc"});let o=c.comments.id(n);if(!o)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xECnh lu\u1EADn"});o.reply.push({userId:t.user.id,content:a,create_at:Date.now()}),await c.save(),e.status(201).json({success:!0,message:"Tr\u1EA3 l\u1EDDi b\xECnh lu\u1EADn th\xE0nh c\xF4ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}}});var Ks=p((Pt,$s)=>{var Re=require("./node_modules/express/index.js"),v=Re.Router(),{addLesson:Je,getAllLessons:ze,getLesson:Me,getCommentsOfLesson:We,newComment:Fe,replyComment:Xe}=qs(),K=C();v.post("/add-lesson",K,Je);v.get("/get-all-lessons",K,ze);v.get("/get-lesson/:courseId/:lessonId",K,Me);v.get("/get-comments-of-lesson/:lessonId",K,We);v.post("/new-comment",K,Fe);v.post("/reply-comment",K,Xe);$s.exports=v});var Z=p((Rt,Ts)=>{var Ds=require("./node_modules/mongoose/index.js"),Ye=new Ds.Schema({answer_content:{type:[String]},language:{type:String},version:{type:String},pre_code:{type:String},next_code:{type:String},public_testcases:{type:[{input:String,expected_output:String}]},private_testcases:{type:[{input:String,expected_output:String}]},create_at:{type:Date,default:Date.now},update_at:{type:Date,default:Date.now}});Ts.exports=Ds.model("Answers",Ye)});var As=p(J=>{var Qe=S(),Ve=I(),ss=P(),Ge=Z();J.getAllAssignments=async(t,e)=>{try{if(t.user.role!=="admin"&&t.user.role!=="instructor")return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n xem t\u1EA5t c\u1EA3 b\xE0i t\u1EADp"});let s=await ss.find().sort({create_at:"desc"}).populate("course","course_title");e.status(200).json({success:!0,data:s})}catch(s){e.status(500).json({success:!1,message:s.message})}};J.addAssignment=async(t,e)=>{try{let{chapter_number:s,assignment:n}=t.body,{role:a,id:c}=t.user;s=parseInt(s);let o=await Ve.findById(n.course);if(!o)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y kh\xF3a h\u1ECDc"});if(a!=="admin"&&c!==o.instructor.toString())return e.status(403).json({success:!1,message:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n th\xEAm b\xE0i t\u1EADp"});let r=await Ge.create(n.answers);n.answers=r._id;let u=await ss.create(n),i=o.chapters.find(d=>d.order===s);if(!i)if(s==o.chapters.length+1||s===o.chapters[o.chapters.length-1].order+1)o.chapters.push({chapter_title:`Ch\u01B0\u01A1ng ${s}`,order:s,content:[]}),i=o.chapters[o.chapters.length-1],(await Qe.find({courseId:o._id})).forEach(g=>{g.progress.push({chapter_order:s,lessons_completed:[],assignments_completed:[],status:"not-started"}),g.save()});else return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y ch\u01B0\u01A1ng, h\xE3y t\u1EA1o ch\u01B0\u01A1ng m\u1EDBi"});i.content.push({content_type:"assignment",assignment_id:u._id.toString(),order:i.content.length+1}),await o.save(),e.status(201).json({success:!0,data:u})}catch(s){e.status(500).json({success:!1,message:s.message})}};J.getAssignmentById=async(t,e)=>{try{let{id:s}=t.params,{role:n}=t.user,a=ss.findById(s).populate("course","course_title");(n==="admin"||n==="instructor")&&(a=a.populate("answers"));let c=await a;if(!c)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i t\u1EADp"});e.status(200).json({success:!0,data:c})}catch(s){e.status(500).json({success:!1,message:s.message})}}});var Ls=p((zt,Os)=>{var He=require("./node_modules/express/index.js"),z=He.Router(),{getAllAssignments:Ze,addAssignment:st,getAssignmentById:et}=As(),es=C();z.get("/get-all-assignments",es,Ze);z.post("/add-assignment",es,st);z.get("/get-assignment/:id",es,et);Os.exports=z});var Es=p((Mt,Us)=>{var M=require("./node_modules/mongoose/index.js"),tt=new M.Schema({assignmentId:{type:M.Schema.Types.ObjectId,ref:"Assignments"},userId:{type:M.Schema.Types.ObjectId,ref:"Users"},submission_detail:{type:[{content:[String],testcases:{public:[{input:String,expected_output:String,output:String,status:String}],private:[{status:String,input:String,your_output:String}]},submit_at:{type:Date,default:Date.now},score:Number}]},highest_score:{type:Number},submit_count:{type:Number,default:0}});Us.exports=M.model("Submissions",tt)});var Js=p(as=>{var D=Es(),nt=P(),Ns=Z(),at=I(),Ps=S(),ot=require("./node_modules/axios/dist/node/axios.cjs");async function Rs(t,e,s,n=""){let a=n.split(" "),c={language:t,version:e,files:[{name:"main",content:s}],stdin:t==="c++"||t==="python"?n:null,args:t==="javascript"?a:null,compile_timeout:1e4,run_timeout:5e3,compile_memory_limit:-1,run_memory_limit:-1};try{return(await ot.post("https://emkc.org/api/v2/piston/execute",c,{headers:{"Content-Type":"application/json"}})).data.run.stdout}catch(o){return console.error("L\u1ED7i:",o.response?o.response.data:o.message),null}}async function rt(t,e,s,n,a){let c=0,o={score:0,testcases:{public:[],private:[]}};for(let[r,u]of s.entries()){let i=await Rs(t,e,a,u.input);i===u.expected_output?(console.log(`Testcase ${r+1}: \u0110\xFAng`),c++,o.testcases.public.push({input:u.input,expected_output:u.expected_output,output:i,status:"correct"})):(console.log(`Testcase ${r+1}: Sai (\u0110\u1EA7u ra: ${i}, K\u1EF3 v\u1ECDng: ${u.expected_output})`),o.testcases.public.push({input:u.input,expected_output:u.expected_output,output:i,status:"wrong"}))}if(c!=s.length)return o;for(let[r,u]of n.entries()){let i=await Rs(t,e,a,u.input);i===u.expected_output?(console.log(`Testcase ${r+1}: \u0110\xFAng`),c++,o.testcases.private.push({status:"correct",input:u.input,your_output:i})):(console.log(`Testcase ${r+1}: Sai (\u0110\u1EA7u ra: ${i}, K\u1EF3 v\u1ECDng: ${u.expected_output})`),o.testcases.private.push({status:"wrong",input:u.input,your_output:i}))}return console.log(`
K\u1EBFt qu\u1EA3: ${c}/${s.length+n.length} testcase \u0111\xFAng`),o.score=c/(s.length+n.length)*10,o}function ts(t,e){let s=t.progress.length;for(;s<e;)t.progress.push({chapter_order:s,assignments_completed:[],status:"in-progress"}),s++;t.save()}function ns(t,e,s,n){t.progress[e-1].assignments_completed.indexOf(s)===-1&&t.progress[e-1].assignments_completed.push(s),t.progress[e-1].status==="not-started"&&(t.progress[e-1].status="in-progress"),t.progress[e-1].assignments_completed.length+t.progress[e-1].lessons_completed.length===n.chapters[e-1].content.length&&(t.progress[e-1].status="completed")}as.addSubmission=async(t,e)=>{try{let{id:s}=t.user,{assignmentId:n,courseId:a}=t.body,c=await nt.findById(n),o=await at.findById(a);console.log("Course: "),console.log(o);let r=await Ps.findOne({userId:s,courseId:a});r||(r=await Ps.create({userId:s,courseId:a,progress:o.chapters.map(i=>({chapter_id:i._id,status:"not-started",lessons_completed:[],assignments_completed:[]}))}));let u=-1;for(let i of o.chapters)if(i.content.some(g=>g.assignment_id&&g.assignment_id.toString()===n)){u=i.order;break}if(!c)return e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i t\u1EADp t\u01B0\u01A1ng \u1EE9ng"});if(console.log("Type: "+c.type),c.type==="quiz"||c.type==="fill"){let i={},d=await Ns.findById(c.answers);console.log("Answer: "+d);let{submission_content:g}=t.body,l=await D.findOne({assignmentId:n,userId:s}),m=0;for(let j=0;j<g.length;j++)d.answer_content[j].toLowerCase()===g[j]&&m++;let h=m/d.answer_content.length*10;if(l){if(l.submit_count>10)return e.status(400).json({success:!1,message:"B\u1EA1n \u0111\xE3 n\u1ED9p b\xE0i qu\xE1 10 l\u1EA7n"});if(l.submit_count++,!d)return l.submission_detail.push({content:g}),e.status(200).json({success:!0,message:"\u0110\xE3 n\u1ED9p b\xE0i nh\u01B0ng ch\u01B0a c\xF3 \u0111\xE1p \xE1n, h\xE3y ch\u1EDD th\u1EA7y gi\xE1o ch\u1EA5m!"});(!l.highest_score||h>l.highest_score)&&(l.highest_score=h),l.submission_detail.push({content:g,score:h}),console.log("Submission Detail: "+l.submission_detail),await l.save(),console.log(1),i=l,console.log("existedSubmission: "+i)}else{if(!d)return(await D.create({assignmentId:n,userId:s,submit_count:1,submission_detail:[{content:g}]})).save(),e.status(200).json({success:!0,message:"\u0110\xE3 n\u1ED9p b\xE0i nh\u01B0ng ch\u01B0a c\xF3 \u0111\xE1p \xE1n, h\xE3y ch\u1EDD th\u1EA7y gi\xE1o ch\u1EA5m!"});let j=await D.create({assignmentId:n,userId:s,submit_count:1,submission_detail:[{content:g,score:h}],highest_score:h});j.save(),i=j}return h>=7&&(ts(r,u),ns(r,u,n,o)),console.log("Submission: "+i),e.status(200).json({success:!0,data:i})}else if(c.type==="code"){let i=await Ns.findById(c.answers),{submission_content:d}=t.body;console.log("content: "+d);let g=`
${i.pre_code}
${d}
${i.next_code}
`;console.log(g);let l=await rt(i.language,i.version,i.public_testcases,i.private_testcases,g);console.log("Public length:"+l.testcases.public.length),console.log("Private length:"+l.testcases.private.length);let m=await D.findOne({assignmentId:n,userId:s});if(m)return m.submit_count>20?e.status(400).json({success:!1,message:"B\u1EA1n \u0111\xE3 n\u1ED9p b\xE0i qu\xE1 20 l\u1EA7n"}):(m.submit_count++,m.submission_detail.unshift({content:d,testcases:l.testcases,score:l.score}),(!m.highest_score||l.score>m.highest_score)&&(m.highest_score=l.score),ts(r,u),l.score>=7&&ns(r,u,n,o),await m.save(),e.status(200).json({success:!0,data:m}));{let h=await D.create({assignmentId:n,userId:s,submit_count:1,submission_detail:[{content:d,testcases:l.testcases,score:l.score}],highest_score:l.score});return ts(r,u),l.score>=7&&ns(r,u,n,o),h.save(),e.status(201).json({success:!0,data:h})}}}catch(s){e.status(500).json({success:!1,message:s.message})}};as.getSubmission=async(t,e)=>{try{let{id:s}=t.user,{assignmentId:n}=t.params,a=await D.findOne({assignmentId:n,userId:s});return a?e.status(200).json({success:!0,data:a}):e.status(404).json({success:!1,message:"Kh\xF4ng t\xECm th\u1EA5y b\xE0i n\u1ED9p t\u01B0\u01A1ng \u1EE9ng"})}catch(s){e.status(500).json({success:!1,message:s.message})}}});var Ws=p((Ft,Ms)=>{var ct=require("./node_modules/express/index.js"),os=ct.Router(),{addSubmission:ut,getSubmission:it}=Js(),zs=C();os.post("/add-submission",zs,ut);os.get("/get-submission/:assignmentId",zs,it);Ms.exports=os});var Fs=p(cs=>{var rs=S(),lt=I();cs.getCourseProgress=async(t,e)=>{try{let{courseId:s}=t.params,{id:n}=t.user,a=await rs.findOne({userId:n,courseId:s});return a?e.status(200).json({success:!0,data:a}):e.status(404).json({success:!1,message:"Course progress not found"})}catch(s){e.status(500).json({success:!1,message:s.message})}};cs.completeLesson=async(t,e)=>{try{let{courseId:s,lessonId:n}=t.params,{id:a}=t.user,c=await rs.findOne({userId:a,courseId:s}),o=await lt.findById(s);c||(c=await rs.create({userId:a,courseId:s,progress:o.chapters.map(u=>({chapter_id:u._id,status:"not-started",lessons_completed:[],assignments_completed:[]}))}));let r=o.chapters.find(u=>u.content.find(i=>i.lesson_id.toString()===n.toString())).order;return o.chapters[r-1].content.find(u=>u.lesson_id.toString()===n.toString())===void 0?e.status(404).json({success:!1,message:"Lesson not found"}):c.progress[r-1].lessons_completed.includes(n)?e.status(400).json({success:!1,message:"Lesson already completed"}):(c.progress[r-1].lessons_completed.push(n),c.progress[r-1].status==="not-started"&&(c.progress[r-1].status="in-progress"),c.progress[r-1].assignments_completed.length+c.progress[r-1].lessons_completed.length===o.chapters[r-1].content.length&&(c.progress[r-1].status="completed"),await c.save(),e.status(200).json({success:!0,message:"Lesson completed"}))}catch(s){e.status(500).json({success:!1,message:s.message})}}});var Qs=p((Yt,Ys)=>{var dt=require("./node_modules/express/index.js"),us=dt.Router(),{getCourseProgress:mt,completeLesson:gt}=Fs(),Xs=C();us.get("/get-course-progress/:courseId",Xs,mt);us.put("/complete-lesson/:courseId/:lessonId",Xs,gt);Ys.exports=us});var Gs=require("./node_modules/express/index.js"),Hs=require("./node_modules/body-parser/index.js"),pt=require("path"),ht=require("./node_modules/cors/lib/index.js");require("./node_modules/dotenv/lib/main.js").config();var ft=ws(),yt=ks(),wt=Ks(),_t=Ls(),jt=Ws(),bt=Qs(),Qt=A(),St="mongodb+srv://adung1703:Adung_2003@cluster0.klijv.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0",It=require("./node_modules/mongoose/index.js");It.connect(St,null).then(()=>{console.log("MongoDB connection successful...")}).catch(t=>{console.log("MongoDB connection failed",t.message)});var _=Gs();_.use(Gs.static(pt.join(__dirname)));_.use(ht());_.use(Hs.urlencoded({extended:!1}));_.use(Hs.json());_.use("/user",ft);_.use("/course",yt);_.use("/lesson",wt);_.use("/assignment",_t);_.use("/submission",jt);_.use("/progress",bt);var Vs=process.env.PORT||3e3;_.listen(Vs,()=>{console.log(`Server \u0111ang ch\u1EA1y t\u1EA1i http://localhost:${Vs}`)});
